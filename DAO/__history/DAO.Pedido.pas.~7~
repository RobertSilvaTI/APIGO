unit DAO.Pedido;

interface

uses FireDAC.Comp.Client, FireDAC.DApt, Data.DB, System.JSON, System.SysUtils,
System.StrUtils, Dataset.Serialize, DAO.Connection;

type
  TPedido = class
    private
      FConn: TFDConnection;
      FID_USUARIO: integer;
      procedure Validate(operacao: string);
    public
      constructor Create;
      destructor Destroy; override;

      property ID_USUARIO: integer read FID_USUARIO write FID_USUARIO;

      function Listar(cod_cidade: string): TJSONArray;
      procedure Avaliar;
      procedure Inserir;
  end;

implementation

{ TPedido }

constructor TPedido.Create;
begin
  FConn := TConnection.CreateConnection;
end;

destructor TPedido.Destroy;
begin
  if Assigned(FConn) then
    FConn.Free;
  inherited;
end;

function TPedido.Listar(cod_cidade: string): TJSONArray;
var
  qry: TFDQuery;
begin
  Validate('Listar');

  try
    qry := TFDQuery.Create(nil);
    qry.Connection := FConn;

    with qry do
    begin
      Active := False;
      SQL.Clear;
      SQL.Add('select p.id_pedido, p.id_estabelecimento, e.nome, count(*) as qtd_item, ');
      SQL.Add('p.vl_total, p.dt_pedido, e.url_logo, coalesce(p.avaliacao,0) as avaliacao, ');
      SQL.Add('p.status');
      SQL.Add('from tab_pedido p');
      SQL.Add('join tab_estabelecimento e on e.id_estabelecimento = p.id_estabelecimento');
      SQL.Add('join tab_pedido_item i on i.id_pedido = p.id_pedido');
      SQL.Add('where p.id_usuario = :id_usuario');
      SQL.Add('group by p.id_pedido, p.id_estabelecimento, e.nome, ');
      SQL.Add('p.vl_total, p.dt_pedido, e.url_logo, avaliacao, p.status');
      SQL.Add('order by p.id_pedido desc');

      ParamByName('id_usuario').Value := id_usuario;

      Active := True;
    end;

    Result := qry.ToJSONArray();

  finally
    qry.Free;
  end;
end;

procedure TPedido.Avaliar;
begin

end;

procedure TPedido.Inserir;
begin

end;

procedure TPedido.Validate(operacao: string);
begin
  if (ID_USUARIO <= 0) and MatchStr(operacao, ['Listar']) then
    raise Exception.Create('ID de usuário não informado!');
end;

end.
